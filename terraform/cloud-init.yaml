#cloud-config
# Cloud-init configuration for Recipe Cookbook VM
# This runs on first boot to install Docker and configure the VM

package_update: true
package_upgrade: true

packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - software-properties-common

runcmd:
  # Add Docker's official GPG key
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

  # Add Docker repository
  - echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

  # Update package index
  - apt-get update

  # Install Docker and Docker Compose plugin
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

  # Start and enable Docker service
  - systemctl start docker
  - systemctl enable docker

  # Add admin user to docker group
  - usermod -aG docker ${admin_username}

  # Configure UFW firewall
  - ufw --force enable
  - ufw allow 22/tcp
  - ufw allow 80/tcp
  - ufw allow 443/tcp

  # Create app directory
  - mkdir -p /home/${admin_username}/app
  - chown ${admin_username}:${admin_username} /home/${admin_username}/app

  # Create legacy directory and download legacy files from GitHub
  - mkdir -p /home/${admin_username}/legacy/static /home/${admin_username}/legacy/templates
  - cd /home/${admin_username}/legacy
  - curl -fsSL https://raw.githubusercontent.com/cookbookio/awsome_recipe_cookbook/cicd-start-demo/legacy/api-schema.yaml -o api-schema.yaml
  - curl -fsSL https://raw.githubusercontent.com/cookbookio/awsome_recipe_cookbook/cicd-start-demo/legacy/app.py -o app.py
  - curl -fsSL https://raw.githubusercontent.com/cookbookio/awsome_recipe_cookbook/cicd-start-demo/legacy/requirements.txt -o requirements.txt
  - curl -fsSL https://raw.githubusercontent.com/cookbookio/awsome_recipe_cookbook/cicd-start-demo/legacy/static/style.css -o static/style.css
  - curl -fsSL https://raw.githubusercontent.com/cookbookio/awsome_recipe_cookbook/cicd-start-demo/legacy/templates/home.html -o templates/home.html
  - curl -fsSL https://raw.githubusercontent.com/cookbookio/awsome_recipe_cookbook/cicd-start-demo/legacy/templates/base.html -o templates/base.html
  - curl -fsSL https://raw.githubusercontent.com/cookbookio/awsome_recipe_cookbook/cicd-start-demo/legacy/templates/recipe_detail.html -o templates/recipe_detail.html
  - chown -R ${admin_username}:${admin_username} /home/${admin_username}/legacy

write_files:
  - path: /etc/motd
    content: |
      ==========================================
      Recipe Cookbook CI/CD Demo VM
      ==========================================

      This VM is configured for Docker deployment.

      Docker: $(docker --version)
      Docker Compose: $(docker compose version)

      App directory: ~/app

      To deploy your app:
      1. Ensure you're logged into GHCR: docker login ghcr.io
      2. Your CI/CD pipeline will handle the rest!

      ==========================================

final_message: |
  ==========================================
  Cloud-init completed successfully!
  ==========================================

  The VM is ready for CI/CD deployment.
  Docker and Docker Compose are installed.

  Please logout and login again for docker
  group changes to take effect.

  ==========================================
